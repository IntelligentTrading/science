from utils import datetime_from_timestamp
from data_sources import convert_value_to_USDT, get_price


class Evaluation:
    def __init__(self, strategy, transaction_currency, counter_currency,
                 start_cash, start_crypto, start_time, end_time, evaluate_profit_on_last_order=False):
        self.transaction_currency = transaction_currency
        self.counter_currency = counter_currency
        self.start_cash = start_cash
        self.start_crypto = start_crypto
        self.start_time = start_time
        self.start_price = 0  # get_price(transaction_currency, start_time, counter_currency)
        self.end_time = end_time
        self.strategy = strategy
        self.evaluate_profit_on_last_order = evaluate_profit_on_last_order
        self.execute_orders(strategy.get_orders(start_cash, start_crypto))

    def execute_orders(self, orders, verbose=True):
        cash = self.start_cash
        crypto = self.start_crypto
        self.num_trades = 0

        if verbose:
            output = []
            output.append(str(self.strategy))
            output.append("\n* Order execution log *\n")
            output.append("Start balance: cash = {} {}, crypto = {} {}".format(cash, self.counter_currency, crypto, self.transaction_currency))
            output.append("Start time: {}\n--".format(datetime_from_timestamp(self.start_time)))

        for order in orders:
            assert order.transaction_currency == self.transaction_currency
            delta_crypto, delta_cash = order.execute()
            cash += delta_cash
            crypto += delta_crypto
            if verbose:
                output.append(str(order))
            self.num_trades += 1

        if self.evaluate_profit_on_last_order and self.num_trades > 0:
            self.end_price = orders[-1].unit_price
        else:
            if self.num_trades == 0:
                print("WARNING: no orders were generated by the chosen strategy.")
            self.end_price = get_price(self.transaction_currency, self.end_time, self.counter_currency)

        self.end_cash = cash
        self.end_crypto = crypto

        self.start_value = self.start_cash + self.start_price * self.start_crypto
        self.end_value = self.end_cash + self.end_price * self.end_crypto
        self.profit_value = self.end_value - self.start_value
        self.profit_percent = self.profit_value/self.start_value*100

        if self.counter_currency != "USDT":
            self.start_value_USDT = convert_value_to_USDT(self.start_cash, self.start_time, self.counter_currency)
            self.start_value_USDT += convert_value_to_USDT(self.start_crypto, self.start_time, self.transaction_currency)
            self.end_value_USDT = convert_value_to_USDT(self.end_cash, self.end_time, self.counter_currency)
            self.end_value_USDT += convert_value_to_USDT(self.end_price * self.end_crypto, self.end_time, self.counter_currency)
            self.profit_USDT = self.end_value_USDT - self.start_value_USDT
            self.profit_percent_USDT = self.profit_USDT / self.start_value_USDT * 100


        if verbose:
            output.append("--")
            output.append("End time: {}".format(datetime_from_timestamp(self.end_time)))
            output.append("\nSummary")
            output.append("--")
            output.append("Number of trades: {}".format(self.num_trades))
            output.append("End cash: {0:.2f} {1}".format(cash, self.counter_currency))
            output.append("End crypto: {0:.6f} {1}".format(crypto, self.transaction_currency))

            sign = "+" if self.profit_value >= 0 else ""
            output.append("Total value invested: {} {}".format(self.start_value, self.counter_currency))
            output.append("Total value after investment: {0:.2f} {1} ({2}{3:.2f}%)".format(self.end_value, self.counter_currency, sign, self.profit_percent))
            output.append("Profit: {0:.2f} {1}".format(self.profit_value, self.counter_currency))

            if self.counter_currency != "USDT":
                sign = "+" if self.profit_USDT >= 0 else ""
                output.append("Total value invested: {:.2f} {} (conversion on {})".format(self.start_value_USDT, "USDT", datetime_from_timestamp(self.start_time)))
                output.append(
                    "Total value after investment: {0:.2f} {1} ({2}{3:.2f}%) (conversion on {4})".format(self.end_value_USDT, "USDT", sign,
                                                                                     self.profit_percent_USDT, datetime_from_timestamp(self.end_time)))
                output.append("Profit: {0:.2f} {1}".format(self.profit_USDT, "USDT"))

            f = open("log.txt", "w")
            f.write("\n".join(output))
            f.close()

            print("\n".join(output))


